<!DOCTYPE html>
<html>

<head>
    <title>Employee Analytics Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .stats-card {
            border-radius: 15px;
            transition: transform 0.3s, box-shadow 0.3s;
            border: none;
        }

        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .dashboard-header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 15px 25px;
            margin-bottom: 20px;
        }

        .chart-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .employee-table {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            overflow: hidden;
        }

        .score-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .score-excellent {
            background: linear-gradient(135deg, #00b894, #00cec9);
            color: white;
        }

        .score-good {
            background: linear-gradient(135deg, #0984e3, #74b9ff);
            color: white;
        }

        .score-average {
            background: linear-gradient(135deg, #fdcb6e, #ffeaa7);
            color: #333;
        }

        .score-needs-improvement {
            background: linear-gradient(135deg, #e17055, #fab1a0);
            color: white;
        }

        .score-poor {
            background: linear-gradient(135deg, #d63031, #ff7675);
            color: white;
        }

        .performer-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
        }

        .top-performer-item {
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        }

        .top-performer-item.rank-1 {
            background: linear-gradient(135deg, #ffd700, #fff3cd);
        }

        .top-performer-item.rank-2 {
            background: linear-gradient(135deg, #c0c0c0, #e9ecef);
        }

        .top-performer-item.rank-3 {
            background: linear-gradient(135deg, #cd7f32, #ffe5d0);
        }

        .search-filter-bar {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .search-filter-bar input,
        .search-filter-bar select {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 8px;
        }

        .key-display {
            font-family: monospace;
            font-size: 1.5rem;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 2px dashed #28a745;
        }

        .stat-number {
            font-size: 3rem;
            font-weight: 700;
        }

        /* ===== ANIMATIONS ===== */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.02);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes glow {

            0%,
            100% {
                box-shadow: 0 0 5px rgba(255, 255, 255, 0.2);
            }

            50% {
                box-shadow: 0 0 20px rgba(255, 255, 255, 0.4);
            }
        }

        /* Animated cards */
        .stats-card {
            animation: fadeInUp 0.5s ease-out;
            cursor: pointer;
        }

        .stats-card:nth-child(2) {
            animation-delay: 0.1s;
        }

        .stats-card:nth-child(3) {
            animation-delay: 0.2s;
        }

        .stats-card:nth-child(4) {
            animation-delay: 0.3s;
        }

        .stats-card:nth-child(5) {
            animation-delay: 0.4s;
        }

        .stats-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
        }

        .stats-card:active {
            transform: scale(0.98);
        }

        /* Stat number animation */
        .stat-number {
            transition: all 0.3s ease;
        }

        .stats-card:hover .stat-number {
            transform: scale(1.1);
        }

        /* Chart card animations */
        .chart-card {
            animation: fadeInUp 0.6s ease-out;
            transition: all 0.3s ease;
        }

        .chart-card:hover {
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        /* Table row animations */
        .employee-table tbody tr {
            animation: slideInRight 0.4s ease-out;
            transition: all 0.2s ease;
        }

        .employee-table tbody tr:hover {
            background: rgba(0, 184, 148, 0.1);
            transform: scale(1.01);
        }

        /* Performer items */
        .top-performer-item {
            transition: all 0.3s ease;
        }

        .top-performer-item:hover {
            transform: translateX(5px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        /* Modal styling */
        .modal-content {
            border-radius: 20px;
            border: none;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
        }

        .modal.fade .modal-dialog {
            transform: scale(0.9) translateY(-50px);
            transition: all 0.3s ease-out;
        }

        .modal.show .modal-dialog {
            transform: scale(1) translateY(0);
        }

        .employee-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            margin: 8px 0;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 12px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .employee-list-item:hover {
            transform: translateX(5px);
            background: linear-gradient(135deg, #e9ecef, #dee2e6);
        }

        /* Loading spinner */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: #00b894;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Refresh pulse */
        .refreshing {
            animation: pulse 0.5s ease-in-out;
        }
    </style>
</head>

<body>
    <div class="container-fluid px-4 py-3">
        <!-- Header -->
        <div class="dashboard-header d-flex justify-content-between align-items-center">
            <div>
                <span class="text-muted">Welcome,</span>
                <strong id="supervisor-name">Loading...</strong>
                <span class="badge bg-primary ms-2" id="company-badge">Company</span>
            </div>
            <div>
                <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#addEmployeeModal">
                    ‚ûï Add Employee
                </button>
                <a href="/logout" class="btn btn-outline-danger">
                    üö™ Logout
                </a>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-success text-white stats-card shadow"
                    onclick="openStatusModal('Present', 'üü¢ Online Employees', 'success')">
                    <div class="card-body text-center">
                        <h6 class="card-title mb-1">üü¢ Online</h6>
                        <div class="stat-number" id="count-present">0</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-dark stats-card shadow"
                    onclick="openStatusModal('BREAK_START', '‚òï On Break', 'warning')">
                    <div class="card-body text-center">
                        <h6 class="card-title mb-1">‚òï On Break</h6>
                        <div class="stat-number" id="count-break">0</div>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card bg-danger text-white stats-card shadow"
                    onclick="openStatusModal('Away', '‚ö†Ô∏è Away Employees', 'danger')">
                    <div class="card-body text-center">
                        <h6 class="card-title mb-1">‚ö†Ô∏è Away</h6>
                        <div class="stat-number" id="count-away">0</div>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card bg-secondary text-white stats-card shadow"
                    onclick="openStatusModal('Offline', '‚ö´ Offline Employees', 'secondary')">
                    <div class="card-body text-center">
                        <h6 class="card-title mb-1">‚ö´ Offline</h6>
                        <div class="stat-number" id="count-offline">0</div>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card bg-info text-white stats-card shadow"
                    onclick="openStatusModal('', 'üë• All Employees', 'info')">
                    <div class="card-body text-center">
                        <h6 class="card-title mb-1">üë• Total</h6>
                        <div class="stat-number" id="count-total">0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <div class="col-md-5">
                <div class="chart-card">
                    <h5>üìä Current Status Distribution</h5>
                    <canvas id="statusPieChart" height="200"></canvas>
                </div>
            </div>
            <div class="col-md-4">
                <div class="performer-card h-100">
                    <h5>üèÜ Top Performers</h5>
                    <div id="top-performers"></div>
                    <hr>
                    <h6 class="text-danger">üö´ Currently Away</h6>
                    <div id="currently-away"></div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="chart-card h-100">
                    <h5>üìù Recent Activity</h5>
                    <div id="recent-activity" style="max-height: 250px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>

        <!-- Search and Filter -->
        <div class="search-filter-bar">
            <div class="row">
                <div class="col-md-3">
                    <input type="text" class="form-control" id="searchInput" placeholder="üîç Search employees...">
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="statusFilter">
                        <option value="">All Statuses</option>
                        <option value="Present">Present</option>
                        <option value="Away">Away</option>
                        <option value="BREAK_START">On Break</option>
                        <option value="Offline">Offline</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="dateFilter">
                        <option value="today">üìÖ Today</option>
                        <option value="7">Last 7 Days</option>
                        <option value="30">Last 30 Days</option>
                        <option value="custom">Custom Date</option>
                    </select>
                </div>
                <div class="col-md-3" id="customDateContainer" style="display: none;">
                    <input type="date" class="form-control" id="customDate">
                </div>
                <div class="col-md-2">
                    <button class="btn btn-light w-100" onclick="resetFilters()">Reset</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Employee Table -->
    <div class="employee-table shadow">
        <div class="card-header bg-dark text-white py-3">
            <h5 class="mb-0">üìã Employee Performance</h5>
        </div>
        <div class="card-body p-0">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Rank</th>
                        <th>Employee</th>
                        <th>Department</th>
                        <th>Away Time</th>
                        <th>Status</th>
                        <th>Present Time</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="employeeTableBody">
                    <!-- Rows populated by JS -->
                </tbody>
            </table>
        </div>
    </div>
    </div>

    <!-- Add Employee Modal -->
    <div class="modal fade" id="addEmployeeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">‚ûï Add New Employee</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="addEmployeeForm">
                        <div class="mb-3">
                            <label class="form-label">Employee Name</label>
                            <input type="text" class="form-control" id="employeeName" placeholder="Enter employee name"
                                required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Department (Optional)</label>
                            <input type="text" class="form-control" id="employeeDept"
                                placeholder="e.g., Engineering, Sales">
                        </div>
                        <button type="button" class="btn btn-success w-100" onclick="createEmployee()">
                            Create Employee & Generate Key
                        </button>
                    </div>
                    <div id="keyResult" style="display: none;">
                        <div class="text-center">
                            <p class="text-muted mb-2">Activation Key for <strong id="resultName"></strong>:</p>
                            <div class="key-display text-success" id="resultKey"></div>
                            <p class="text-muted mt-3 small">‚ö†Ô∏è Give this key to the employee.</p>
                        </div>
                        <button type="button" class="btn btn-outline-secondary w-100 mt-3" onclick="resetModal()">
                            Add Another Employee
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Employee List Modal -->
    <div class="modal fade" id="employeeListModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header" id="employeeListModalHeader">
                    <h5 class="modal-title" id="employeeListModalTitle">üë• Employees</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
                    <div id="employeeListContent">
                        <div class="text-center py-4">
                            <div class="loading-spinner"></div>
                            <p class="text-muted mt-2">Loading...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <span class="text-muted me-auto" id="employeeListCount">0 employees</span>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let allScores = [];
        let trendChart = null;

        // Initialize pie chart
        let statusPieChart = null;

        function initChart() {
            const ctx = document.getElementById('statusPieChart').getContext('2d');
            statusPieChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['üü¢ Online', '‚òï On Break', '‚ö†Ô∏è Away', '‚ö´ Offline'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: [
                            '#00b894',
                            '#fdcb6e',
                            '#d63031',
                            '#636e72'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { font: { size: 12 } }
                        }
                    }
                }
            });
        }

        // Update pie chart with current stats
        function updatePieChart(present, breakCount, away, offline) {
            if (statusPieChart) {
                statusPieChart.data.datasets[0].data = [present, breakCount, away, offline];
                statusPieChart.update();
            }
        }

        // Open modal with employee list filtered by status
        function openStatusModal(status, title, colorClass) {
            const modal = new bootstrap.Modal(document.getElementById('employeeListModal'));
            const headerEl = document.getElementById('employeeListModalHeader');
            const titleEl = document.getElementById('employeeListModalTitle');
            const contentEl = document.getElementById('employeeListContent');
            const countEl = document.getElementById('employeeListCount');

            // Set header color
            const colorMap = {
                'success': '#00b894',
                'warning': '#fdcb6e',
                'danger': '#d63031',
                'secondary': '#636e72',
                'info': '#00cec9'
            };
            headerEl.style.background = colorMap[colorClass] || '#00b894';
            headerEl.style.color = colorClass === 'warning' ? '#333' : '#fff';

            titleEl.innerText = title;

            // Filter employees
            let filtered = dashboardLogs;
            if (status !== '') {
                filtered = dashboardLogs.filter(emp => {
                    if (status === 'Present') {
                        return ['Present', 'WORK_START', 'BREAK_END'].includes(emp.status);
                    } else if (status === 'Offline') {
                        return emp.status === 'Offline';
                    } else {
                        return emp.status === status;
                    }
                });
            }

            // Build employee list HTML
            let html = '';
            if (filtered.length === 0) {
                html = '<div class="text-center py-4"><p class="text-muted">No employees in this category</p></div>';
            } else {
                filtered.forEach((emp, index) => {
                    const statusIcon = getStatusText(emp.status);
                    // Force UTC parsing by adding 'Z' if missing
                    const timeStr = emp.timestamp.endsWith('Z') ? emp.timestamp : emp.timestamp + 'Z';
                    const time = new Date(timeStr).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                    html += `
                        <div class="employee-list-item" onclick="window.location.href='/employee/${emp.employee_name}'" style="animation-delay: ${index * 0.05}s; animation: slideInRight 0.3s ease-out forwards;">
                            <div>
                                <strong>${emp.employee_name}</strong>
                                <small class="d-block text-muted">${emp.department || 'No department'}</small>
                            </div>
                            <div class="text-end">
                                <span class="${getStatusClass(emp.status)} badge">${statusIcon}</span>
                                <small class="d-block text-muted">${emp.present_time || '0h 0m'}</small>
                            </div>
                        </div>
                    `;
                });
            }

            contentEl.innerHTML = html;
            countEl.innerText = `${filtered.length} employee${filtered.length !== 1 ? 's' : ''}`;

            // Also filter the table below
            filterByStatus(status);

            modal.show();
        }

        // Store dashboard logs for filtering
        let dashboardLogs = [];

        // Update dashboard
        const updateDashboard = async () => {
            try {
                const response = await fetch('/dashboard/stats');
                if (response.status === 401) {
                    window.location.href = '/login';
                    return;
                }
                const data = await response.json();

                // Store logs for filtering by status
                dashboardLogs = data.logs || [];

                const present = data.count_present || 0;
                const breakCount = data.count_break || 0;
                const away = data.count_away || 0;
                const offline = data.count_offline || 0;

                document.getElementById('count-present').innerText = present;
                document.getElementById('count-break').innerText = breakCount;
                document.getElementById('count-away').innerText = away;
                document.getElementById('count-offline').innerText = offline;
                document.getElementById('count-total').innerText = dashboardLogs.length;

                // Update pie chart
                updatePieChart(present, breakCount, away, offline);

                // Render recent activity
                // Use the true feed from server if available, fallback to logs
                renderRecentActivity(data.recent_activity || dashboardLogs);

                // Update top performers and currently away (they use dashboardLogs)
                loadTopPerformers();
                loadCurrentlyAway();

                // Also render table with dashboard logs if scores not loaded yet
                if (allScores.length === 0) {
                    renderTableFromLogs(dashboardLogs);
                }
            } catch (error) {
                console.error("Error fetching stats:", error);
            }
        };

        // Render recent activity feed
        function renderRecentActivity(logs) {
            const container = document.getElementById('recent-activity');

            // If it's the raw feed from server, it's already sorted. 
            // If it's dashboardLogs (fallback), we might want to sort.
            // But let's assume valid feed.
            let recent = logs;
            if (!logs[0] || !logs[0].status) recent = []; // Safety check

            // Ensure we handle both dashboardLogs format (logs have timestamp) and feed format
            // Just to be safe, sort if needed, though server sorts.
            // But server returns simplified object.

            let html = '';
            recent.forEach(log => {
                const statusIcon = getStatusText(log.status);
                // Force UTC parsing
                const timeStr = log.timestamp.endsWith('Z') ? log.timestamp : log.timestamp + 'Z';
                const time = new Date(timeStr).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                html += `
                    <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                        <div>
                            <strong>${log.employee_name}</strong>
                            <small class="d-block text-muted">${statusIcon}</small>
                        </div>
                        <small class="text-muted">${time}</small>
                    </div>
                `;
            });
            container.innerHTML = html || '<p class="text-muted small">No recent activity</p>';
        }

        // Filter by status when clicking on cards
        function filterByStatus(status) {
            document.getElementById('statusFilter').value = status;
            if (status === '') {
                // Show all
                renderTableFromLogs(dashboardLogs);
            } else {
                // Filter by status
                const filtered = dashboardLogs.filter(emp => {
                    if (status === 'Present') {
                        return ['Present', 'WORK_START', 'BREAK_END'].includes(emp.status);
                    } else if (status === 'Offline') {
                        return emp.status === 'Offline';
                    } else {
                        return emp.status === status;
                    }
                });
                renderTableFromLogs(filtered);
            }
        }

        // Render table from dashboard logs (not scores)
        function renderTableFromLogs(logs) {
            const tbody = document.getElementById('employeeTableBody');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            let filtered = logs.filter(emp => {
                if (searchTerm && !emp.employee_name.toLowerCase().includes(searchTerm)) return false;
                return true;
            });

            tbody.innerHTML = '';
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">No employees found</td></tr>';
                return;
            }

            filtered.forEach((emp, index) => {
                const statusClass = getStatusClass(emp.status);
                const statusText = getStatusText(emp.status);
                tbody.innerHTML += `
                    <tr>
                        <td><strong>#${index + 1}</strong></td>
                        <td>
                            <a href="/employee/${emp.employee_name}" class="text-decoration-none fw-bold">
                                ${emp.employee_name} ‚Üó
                            </a>
                        </td>
                        <td>${emp.department || '-'}</td>
                        <td><span class="${statusClass}">${statusText}</span></td>
                        <td>${emp.status}</td>
                        <td>${emp.present_time || '0h 0m'}</td>
                        <td>
                            <a href="/employee/${emp.employee_name}" class="btn btn-sm btn-outline-primary">View</a>
                        </td>
                    </tr>
                `;
            });
        }

        function getStatusClass(status) {
            if (['Present', 'WORK_START', 'BREAK_END'].includes(status)) return 'badge bg-success';
            if (status === 'BREAK_START') return 'badge bg-warning text-dark';
            if (status === 'Away') return 'badge bg-danger';
            return 'badge bg-secondary';
        }

        function getStatusText(status) {
            if (['Present', 'WORK_START', 'BREAK_END'].includes(status)) return 'üü¢ Online';
            if (status === 'BREAK_START') return '‚òï On Break';
            if (status === 'Away') return '‚ö†Ô∏è Away';
            return '‚ö´ Offline';
        }

        // Load scores
        const loadScores = async (days = 7) => {
            try {
                const response = await fetch(`/api/scores?days=${days}`);
                if (!response.ok) return;
                const data = await response.json();

                allScores = data.scores;
                renderTable(allScores);
            } catch (error) {
                console.error("Error fetching scores:", error);
            }
        };

        // Load trends
        const loadTrends = async (days = 7) => {
            try {
                const response = await fetch(`/api/analytics/trends?days=${days}`);
                if (!response.ok) return;
                const data = await response.json();

                trendChart.data.labels = data.daily_data.map(d => d.day_name);
                trendChart.data.datasets[0].data = data.daily_data.map(d => d.present);
                trendChart.data.datasets[1].data = data.daily_data.map(d => d.away);
                trendChart.update();
            } catch (error) {
                console.error("Error fetching trends:", error);
            }
        };

        // Load top performers (least break time)
        const loadTopPerformers = async () => {
            try {
                // Use dashboard logs to calculate break time
                if (dashboardLogs.length === 0) {
                    document.getElementById('top-performers').innerHTML = '<p class="text-muted">No data</p>';
                    return;
                }

                // Sort by break time (ascending - least break is best)
                // We don't have break time in logs, so we'll show those who are online longest
                const onlineEmployees = dashboardLogs
                    .filter(emp => ['Present', 'WORK_START', 'BREAK_END'].includes(emp.status))
                    .sort((a, b) => {
                        // Parse present time and sort by it (most present = top performer)
                        const getMinutes = (timeStr) => {
                            const match = timeStr.match(/(\d+)h\s*(\d+)m/);
                            if (match) return parseInt(match[1]) * 60 + parseInt(match[2]);
                            return 0;
                        };
                        return getMinutes(b.present_time || '0h 0m') - getMinutes(a.present_time || '0h 0m');
                    });

                let topHtml = '';
                onlineEmployees.slice(0, 3).forEach((p, i) => {
                    const rankColors = ['#ffd700', '#c0c0c0', '#cd7f32'];
                    topHtml += `
                        <div class="top-performer-item rank-${i + 1}" style="background: ${rankColors[i]}22; border-left: 3px solid ${rankColors[i]};">
                            <strong>${i + 1}. ${p.employee_name}</strong>
                            <span class="float-end text-success">üïê ${p.present_time || '0h 0m'}</span>
                        </div>
                    `;
                });
                document.getElementById('top-performers').innerHTML = topHtml || '<p class="text-muted">No online employees</p>';

            } catch (error) {
                console.error("Error loading top performers:", error);
            }
        };

        // Load currently away/offline employees with duration
        const loadCurrentlyAway = async () => {
            try {
                if (dashboardLogs.length === 0) {
                    document.getElementById('currently-away').innerHTML = '<p class="text-muted small">Loading...</p>';
                    return;
                }

                let awayHtml = '';
                dashboardLogs.forEach(emp => {
                    // Check for Away OR Offline status
                    if (emp.status === 'Away' || emp.status === 'Offline') {
                        // Calculate time away
                        const awayTime = new Date(emp.timestamp);
                        const now = new Date();
                        const diffMs = now - awayTime;
                        const diffMins = Math.floor(diffMs / 60000);
                        const hours = Math.floor(diffMins / 60);
                        const mins = diffMins % 60;
                        const timeAway = hours > 0 ? `${hours}h ${mins}m` : `${mins}m`;

                        const isOffline = emp.status === 'Offline';
                        const icon = isOffline ? '‚ö´' : 'üö´';
                        const label = isOffline ? 'Offline' : 'Away';

                        awayHtml += `
                            <div class="top-performer-item" style="border-left: 3px solid ${isOffline ? '#666' : '#dc3545'};">
                                <span class="${isOffline ? 'text-secondary' : 'text-danger'}">${icon} ${emp.employee_name}</span>
                                <small class="float-end ${isOffline ? 'text-secondary' : 'text-danger'} fw-bold">‚è±Ô∏è ${timeAway}</small>
                            </div>
                        `;
                    }
                });
                document.getElementById('currently-away').innerHTML = awayHtml || '<p class="text-muted small">‚úÖ Everyone is present!</p>';
            } catch (error) {
                console.error("Error fetching away employees:", error);
            }
        };

        // Render table
        function renderTable(scores, statusFilterValue = null) {
            const tbody = document.getElementById('employeeTableBody');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = statusFilterValue || document.getElementById('statusFilter').value;

            let filtered = scores.filter(s => {
                if (searchTerm && !s.employee_name.toLowerCase().includes(searchTerm)) return false;
                // Status filter will be applied from dashboard stats data, not scores
                return true;
            });

            tbody.innerHTML = '';
            filtered.forEach((s, index) => {
                const awayHours = s.away_hours || 0;
                const awayClass = awayHours > 2 ? 'text-danger fw-bold' : (awayHours > 1 ? 'text-warning' : 'text-success');
                tbody.innerHTML += `
                    <tr>
                        <td><strong>#${index + 1}</strong></td>
                        <td>
                            <a href="/employee/${s.employee_name}" class="text-decoration-none fw-bold">
                                ${s.employee_name} ‚Üó
                            </a>
                        </td>
                        <td>${s.department}</td>
                        <td>
                            <span class="${awayClass}">‚è±Ô∏è ${awayHours}h</span>
                        </td>
                        <td>${s.days_active} days active</td>
                        <td>${s.present_hours}h</td>
                        <td>
                            <a href="/employee/${s.employee_name}" class="btn btn-sm btn-outline-primary">View</a>
                        </td>
                    </tr>
                `;
            });
        }

        function getScoreClass(grade) {
            switch (grade) {
                case 'Excellent': return 'score-excellent';
                case 'Good': return 'score-good';
                case 'Average': return 'score-average';
                case 'Needs Improvement': return 'score-needs-improvement';
                case 'Poor': return 'score-poor';
                default: return '';
            }
        }

        // Search and filter
        document.getElementById('searchInput').addEventListener('input', () => renderTable(allScores));
        document.getElementById('statusFilter').addEventListener('change', () => renderTable(allScores));
        document.getElementById('dateFilter').addEventListener('change', function () {
            if (this.value === 'custom') {
                document.getElementById('customDateContainer').style.display = 'block';
            } else {
                document.getElementById('customDateContainer').style.display = 'none';
                // Reload scores with new date range
                const days = this.value === 'today' ? 1 : parseInt(this.value);
                loadScores(days);
                loadTrends(days);
            }
        });
        document.getElementById('customDate').addEventListener('change', function () {
            // For custom date, we still use 1 day but centered on selected date
            loadScores(1, this.value);
        });

        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('dateFilter').value = 'today';
            document.getElementById('customDateContainer').style.display = 'none';
            loadScores(1);
            renderTable(allScores);
        }

        // Create Employee
        const createEmployee = async () => {
            const name = document.getElementById('employeeName').value.trim();
            const dept = document.getElementById('employeeDept').value.trim();

            if (!name) {
                alert('Please enter an employee name');
                return;
            }

            try {
                const response = await fetch('/admin/create-employee', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name, department: dept || null })
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('resultName').innerText = data.name;
                    document.getElementById('resultKey').innerText = data.activation_key;
                    document.getElementById('addEmployeeForm').style.display = 'none';
                    document.getElementById('keyResult').style.display = 'block';
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.detail || 'Failed to create employee'));
                }
            } catch (error) {
                alert('Connection error: ' + error.message);
            }
        };

        // Reset Modal
        const resetModal = () => {
            document.getElementById('employeeName').value = '';
            document.getElementById('employeeDept').value = '';
            document.getElementById('addEmployeeForm').style.display = 'block';
            document.getElementById('keyResult').style.display = 'none';
        };

        document.getElementById('addEmployeeModal').addEventListener('hidden.bs.modal', resetModal);

        // Load user info
        const loadUserInfo = async () => {
            try {
                const response = await fetch('/auth/me');
                if (response.ok) {
                    const user = await response.json();
                    document.getElementById('supervisor-name').innerText = user.name;
                    document.getElementById('company-badge').innerText = user.company_name;
                }
            } catch (e) {
                console.error('Failed to load user info:', e);
            }
        };

        // Initialize
        initChart();
        loadUserInfo();
        updateDashboard();
        loadScores();
        loadTopPerformers();
        loadCurrentlyAway();

        // Refresh every 30 seconds
        setInterval(() => {
            updateDashboard();
            loadScores();
            loadTrends();
            loadCurrentlyAway();
        }, 30000);
    </script>
</body>

</html>