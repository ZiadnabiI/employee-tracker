<!DOCTYPE html>
<html>

<head>
    <title>Employee Analytics Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        .stats-card {
            border-radius: 10px;
            transition: transform 0.2s;
        }

        .stats-card:hover {
            transform: scale(1.02);
        }

        .key-display {
            font-family: monospace;
            font-size: 1.5rem;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 2px dashed #28a745;
        }
    </style>
</head>

<body class="bg-light">
    <div class="container mt-4">
        <!-- Company Header -->
        <div class="d-flex justify-content-between align-items-center mb-3 p-3 bg-white rounded shadow-sm">
            <div>
                <span class="text-muted">Welcome,</span>
                <strong id="supervisor-name">Loading...</strong>
                <span class="badge bg-secondary ms-2" id="company-badge">Company</span>
            </div>
            <a href="/logout" class="btn btn-outline-danger btn-sm">
                üö™ Logout
            </a>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>üìä Employee Presence Analytics</h2>
            <div>
                <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#addEmployeeModal">
                    ‚ûï Add Employee
                </button>
                <span class="badge bg-primary">Live Connection Active</span>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card bg-success text-white stats-card shadow">
                    <div class="card-body text-center">
                        <h5 class="card-title">Online / Present</h5>
                        <h2 class="display-4 fw-bold" id="count-present">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-warning text-dark stats-card shadow">
                    <div class="card-body text-center">
                        <h5 class="card-title">On Break</h5>
                        <h2 class="display-4 fw-bold" id="count-break">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-danger text-white stats-card shadow">
                    <div class="card-body text-center">
                        <h5 class="card-title">Away / Missing</h5>
                        <h2 class="display-4 fw-bold" id="count-away">0</h2>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow">
            <div class="card-header bg-dark text-white">Recent Activity Logs</div>
            <div class="card-body">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Employee Name</th>
                            <th>Status</th>
                            <th>Timestamp</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Rows populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add Employee Modal -->
    <div class="modal fade" id="addEmployeeModal" tabindex="-1" aria-labelledby="addEmployeeModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="addEmployeeModalLabel">‚ûï Add New Employee</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="addEmployeeForm">
                        <div class="mb-3">
                            <label for="employeeName" class="form-label">Employee Name</label>
                            <input type="text" class="form-control" id="employeeName" placeholder="Enter employee name"
                                required>
                        </div>
                        <div class="mb-3">
                            <label for="employeeDept" class="form-label">Department (Optional)</label>
                            <input type="text" class="form-control" id="employeeDept"
                                placeholder="e.g., Engineering, Sales">
                        </div>
                        <button type="button" class="btn btn-success w-100" onclick="createEmployee()">
                            Create Employee & Generate Key
                        </button>
                    </div>
                    <div id="keyResult" style="display: none;">
                        <div class="text-center">
                            <p class="text-muted mb-2">Activation Key for <strong id="resultName"></strong>:</p>
                            <div class="key-display text-success" id="resultKey"></div>
                            <p class="text-muted mt-3 small">‚ö†Ô∏è Give this key to the employee. They will enter it in the
                                app to activate their device.</p>
                        </div>
                        <button type="button" class="btn btn-outline-secondary w-100 mt-3" onclick="resetModal()">
                            Add Another Employee
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const updateDashboard = async () => {
            try {
                const response = await fetch('/dashboard/stats');
                const data = await response.json();

                // Update Stats
                document.getElementById('count-present').innerText = data.count_present;
                document.getElementById('count-break').innerText = data.count_break;
                document.getElementById('count-away').innerText = data.count_away;

                // Update Table
                const tbody = document.querySelector('tbody');
                tbody.innerHTML = '';

                data.logs.forEach(log => {
                    const row = `
                    <tr>
                        <td>
                            <a href="/employee/${log.employee_name}" class="text-decoration-none fw-bold text-dark">
                                ${log.employee_name} ‚Üó
                            </a>
                        </td>
                        <td>
                            <span class="badge ${log.status === 'Present' || log.status === 'WORK_START' ? 'bg-success' : 'bg-danger'}">
                                ${log.status}
                            </span>
                        </td>
                        <td>${new Date(log.timestamp).toLocaleTimeString()}</td>
                    </tr>
                `;
                    tbody.innerHTML += row;
                });

            } catch (error) {
                console.error("Error fetching stats:", error);
            }
        };

        // Create Employee Function
        const createEmployee = async () => {
            const name = document.getElementById('employeeName').value.trim();
            const dept = document.getElementById('employeeDept').value.trim();

            if (!name) {
                alert('Please enter an employee name');
                return;
            }

            try {
                const response = await fetch('/admin/create-employee', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name, department: dept || null })
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('resultName').innerText = data.name;
                    document.getElementById('resultKey').innerText = data.activation_key;
                    document.getElementById('addEmployeeForm').style.display = 'none';
                    document.getElementById('keyResult').style.display = 'block';
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.detail || 'Failed to create employee'));
                }
            } catch (error) {
                alert('Connection error: ' + error.message);
            }
        };

        // Reset Modal
        const resetModal = () => {
            document.getElementById('employeeName').value = '';
            document.getElementById('employeeDept').value = '';
            document.getElementById('addEmployeeForm').style.display = 'block';
            document.getElementById('keyResult').style.display = 'none';
        };

        // Reset when modal closes
        document.getElementById('addEmployeeModal').addEventListener('hidden.bs.modal', resetModal);

        setInterval(updateDashboard, 5000);
        updateDashboard();

        // Fetch and display user info
        const loadUserInfo = async () => {
            try {
                const response = await fetch('/auth/me');
                if (response.ok) {
                    const user = await response.json();
                    document.getElementById('supervisor-name').innerText = user.name;
                    document.getElementById('company-badge').innerText = user.company_name;
                }
            } catch (e) {
                console.error('Failed to load user info:', e);
            }
        };
        loadUserInfo();
    </script>
</body>

</html>