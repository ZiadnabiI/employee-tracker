<!DOCTYPE html>
<html>

<head>
    <title>Employee Details - {{ name }}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        .timeline-card {
            border-left: 4px solid #1877f2;
        }
    </style>
</head>

<body class="bg-light">
    <div class="container mt-5">
        <a href="/" class="btn btn-outline-secondary mb-3">&larr; Back to Dashboard</a>

        <div class="card shadow mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <h2 class="card-title">{{ name }}</h2>
                    <span id="live-status" class="badge bg-secondary">Loading...</span>
                </div>
                <hr>
                <div class="row text-center">
                    <div class="col-md-4">
                        <h4 class="text-success">Present</h4>
                        <h2 id="present-time">--</h2>
                    </div>
                    <div class="col-md-4">
                        <h4 class="text-warning">On Break</h4>
                        <h2 id="break-time">--</h2>
                    </div>
                    <div class="col-md-4">
                        <h4 class="text-danger">Away/Missing</h4>
                        <h2 id="away-time">--</h2>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow">
            <div class="card-header bg-dark text-white">Full Activity History</div>
            <div class="card-body">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Time</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody id="history-body">
                        <!-- Data populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const employeeName = "{{ name }}";

        const loadData = async () => {
            try {
                const response = await fetch(`/api/employee/${employeeName}/stats`);
                const data = await response.json();

                document.getElementById('present-time').innerText = data.present_today;
                document.getElementById('break-time').innerText = data.break_today;
                document.getElementById('away-time').innerText = data.away_today;

                const historyBody = document.getElementById('history-body');
                historyBody.innerHTML = '';

                // Add Latest Status Badge
                if (data.logs.length > 0) {
                    const latest = data.logs[0].status;
                    const badge = document.getElementById('live-status');
                    badge.innerText = latest;
                    badge.className = `badge ${latest === 'Present' || latest === 'WORK_START' ? 'bg-success' : 'bg-warning'}`;
                }

                data.logs.forEach(log => {
                    const date = new Date(log.timestamp);
                    const row = `
                        <tr>
                            <td><span class="badge ${log.status === 'Present' ? 'bg-success' : 'bg-secondary'}">${log.status}</span></td>
                            <td>${date.toLocaleTimeString()}</td>
                            <td>${date.toLocaleDateString()}</td>
                        </tr>
                    `;
                    historyBody.innerHTML += row;
                });

            } catch (error) {
                console.error("Error loading details", error);
            }
        };

        loadData();
        setInterval(loadData, 5000); // Live update
    </script>
</body>

</html>